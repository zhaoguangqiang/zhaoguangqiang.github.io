---
layout:	post
title:	"install k8s"
date:	2019-08-24
tags:	["kubernetes"]
image:	""
---

# 源:
|  global              | proxy in China    | format                                               |                                   example                                          |
| --------             | :---------------: | :--------------------------------------------------: | :-------------------------------------------------------------------------------:  |
| dockerhub (docker.io)| dockerhub.azk8s.cn| dockerhub.azk8s.cn/<repo-name>/<image-name>:<version>| dockerhub.azk8s.cn/microsoft/azure-cli:2.0.61 dockerhub.azk8s.cn/library/nginx:1.15|
| gcr.io               | gcr.azk8s.cn      | gcr.azk8s.cn/<repo-name>/<image-name>:<version>      | gcr.azk8s.cn/google_containers/hyperkube-amd64:v1.13.5                             |
| quay.io              | quay.azk8s.cn     | quay.azk8s.cn/<repo-name>/<image-name>:<version>     | quay.azk8s.cn/deis/go-dev:v1.10.0                                                  |


install k8s
===

install Master
---

#### install software
```shell
curl -fsSL https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu/gpg | sudo apt-key add -
sudo apt update
* The following signatures couldn't be verified because the public key is not available: NO_PUBKEY 6A030B21BA07F4FB
* You should check you PUBKEY
* sudo apt-key adv --keyserver keyserver.ubuntu.com YOUR_KEY
sudo vim /etc/apt/sources.list
add:
  deb http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial main
sudo apt install docker.io kubeadm kubectl kubelet
sudo systemctl start docker kubelet
sudo systemctl enable docker kubelet
```

#### prepare kubernetes plugin docker
```shell
kubeadm token list //To get the kube plugin docker version

#!/bin/bash
images=(
	kube-apiserver:v1.15.2
	kube-controller-manager:v1.15.2
	kube-scheduler:v1.15.2
	kube-proxy:v1.15.2

	pause:3.1
	etcd:3.3.10
	coredns:1.3.1
	kubernetes-dashboard-amd64:v1.10.0
)


for imageName in ${images[@]} ; do
    docker pull gcr.azk8s.cn/google_containers/$imageName
    docker tag gcr.azk8s.cn/google_containers/$imageName k8s.gcr.io/$imageName
    docker rmi gcr.azk8s.cn/google_containers/$imageName
done
```

#### install service
```shell
udo kubeadm init --kubernetes-version=v1.15.2 --apiserver-advertise-address=172.23.127.113 --pod-network-cidr=192.168.0.0/16
```

support Node on Master:
  kubectl taint node --all node-role.kubernetes.io/master-
disable support Node on Master:
  kubectl taint node MASTERNAME node-role.kubernetes.io/master="":NoSchedule

#### install network
wget https://docs.projectcalico.org/v3.8/manifests/calico.yaml
kubectl apply -f calico.yaml

#### install metric负载
cd metrics-server/
vim deploy/1.8+/metrics-server-deployment.yaml
cd metrics-server/
cd ../metrics-server/
docker rmi zhaogq.test/metrics-server-amd64:v0.3.3
kubectl describe metrics-server
docker tag k8s.gcr.io/metrics-server-amd64:v0.3.3 zhaogq.test/metrics-server-amd64:v0.3.3
docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.3
docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64
docker images | grep metric
kubectl get pods metrics-server-6d7c9596cb-jt7hh --namespace=kube-system -o yaml | grep image
kubectl get pods metrics-server-6d7c9596cb-jt7hh --namespace=kube-system -o yaml | grep yaml
kubectl get pods metrics-server-6d7c9596cb-jt7hh --namespace=kube-system -o yaml
kubectl get pods metrics-server-6d7c9596cb-jt7hh --namespace=kube-system
kubectl get pods metrics-server-6d7c9596cb-jt7hh ns=kube-system
kubectl get pods metrics-server-6d7c9596cb-jt7hh -ns=kube-system
kubectl get pods metrics-server-6d7c9596cb-jt7hh --ns=kube-system
kubectl get pods metrics-server-6d7c9596cb-jt7hh
docker ps -a | grep metric
kubectl delete pods metrics-server-6d7c9596cb-2nmpl --namespace=kube-system
kubectl describe contianers metrics-server
docker images | grep k8s.gcr.io/metrics-server-amd64:v0.3.3
kubectl -n metrics logs -l app=metrics-server
helm ls metrics-server
kubectl describe deployment metrics-server --namespace=kube-system
kubectl describe deployment metrics-server
vim deploy/1.8+/metrics-server-service.yaml
vim metrics-server/
docker search metrics-server
kubectl describe deployment metrics-server -n kube-system
kubectl delete deployment metrics-server
kubectl delete deployment metrics-server --namespace=kube-system
kubectl get deployment metrics-server -n kube-system
git clone https://github.com/kubernetes-incubator/metrics-server.git
git clone git@github.com:kubernetes-incubator/metrics-server.git

#### install ingress
nginx-ingress-controller:0.25.0
git clone https://github.com/kubernetes/ingress-nginx.git
kubectl apply -f deploy/static/mandatory.yaml

https://github.com/kubernetes/ingress-nginx
安装过程中，ingress需要放置到master节点上，master节点下载ingress镜像，但是可能会分配至node节点，出现无法找到image的情况
git clone https://github.com/kubernetes/ingress-nginx.git
./autoReplaceImages.sh
cd ingress-nginx
//向mandatory中的ingress-nginx-controller的中添加:
// 使用hostNetwork暴露服务
   hostNetwork: true
kubectl apply -f deploy/static/mandatory.yaml
//部署ingress svc不确定是否需要部署
//部署ingress与service之间的映射

openssl req -x509 -new -nodes -key ca-key.pem -days 10000 -out ncserver-ca.crt -subj "/CN=ncserver-ca"
kubectl create secret tls ingress-secret --key ca-key.pem  --cert ncserver-ca.crt

add tls to Ingress.spec
```
tls:
- hosts:
	- k8s.navicore.cn
	secretName: ingress-secret
```
kubectl apply -f ingress.yaml


## HPA
heapster已废弃
metric-server使用

kubectl delete deployment heapster --namespace=kube-system
kubectl get deployment heapster --namespace=kube-system

下载metrics-server镜像
```
  git clone https://github.com/kubernetes-incubator/metrics-server.git
  cd metrics-server

  vim deploy/1.8+/metrics-server-deployment.yaml
  无法使用本地镜像
  modify:
    imagePullPolicy : modify "Always" to "ifNotPresent"
  add: 
    args:
    - --kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP
    - --kubelet-insecure-tls

  kubectl create -f deploy/1.8+

  kubectl top node
```
kubectl describe hpa

//modify controller-manager
vim /etc/kubernetes/manifests/
controller auto check file and etcd,if different restart controller-managerment




install Node
---

#### install software
 ```shell
sudo apt install docker.io kubelet kubeadm
systemctl enable docker kubelet
 ```

#### prepare kubernetes plugin docker
 ```shell
#!/bin/bash
 images=(
		 kube-proxy:v1.15.2
		 pause:3.1
	)

 for imageName in ${images[@]} ; do
 docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName
 docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName k8s.gcr.io/$imageName
 done
```
## join to master
 sudo kubeadm join 172.23.127.113:6443 --token atg34o.2nwr0dn6ttojbt4h --discovery-token-ca-cert-hash sha256:3d236eac9a79894db27ed38cef6022e7051c5df54384a3f3d9740ab57fb92e35 
 get token from master : kubeadm token create
 get  openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'





注:
dashboard token 不小心被删
```
kubectl get secret -n kube-system | grep admin
kubectl describe YOUR_SECRET_NAME -n kube-sytem
```

